@page "/plan"
@using RequirementsLab.Models
@using RequirementsLab.Services
@using Markdig
@inject ImplementationPlanService PlanService
@inject NavigationManager Navigation

<PageTitle>å¯¦ä½œè¦åŠƒæ›¸ - RequirementsLab</PageTitle>

<div class="container py-4">
    <div class="d-flex align-items-center mb-4">
        <button class="btn btn-outline-secondary me-3" @onclick="GoBack">
            <i class="bi bi-arrow-left"></i> è¿”å›
        </button>
        <h2 class="mb-0">ğŸ“‹ å¯¦ä½œè¦åŠƒæ›¸</h2>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
            <h4 class="text-light">ğŸ¤– AI æ­£åœ¨æ’°å¯«å¯¦ä½œè¦åŠƒæ›¸...</h4>
            <p class="text-muted">é€™å¯èƒ½éœ€è¦ 30-60 ç§’ï¼Œè«‹ç¨å€™...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(planMarkdown))
    {
        <div class="row">
            <div class="col-lg-10 mx-auto">
                <div class="card bg-dark border-secondary">
                    <div class="card-header border-secondary d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i>@solution?.Name</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-info me-2" @onclick="CopyToClipboard">
                                <i class="bi bi-clipboard"></i> è¤‡è£½
                            </button>
                            <button class="btn btn-sm btn-outline-success" @onclick="DownloadMarkdown">
                                <i class="bi bi-download"></i> ä¸‹è¼‰ .md
                            </button>
                        </div>
                    </div>
                    <div class="card-body markdown-content" style="max-height: 70vh; overflow-y: auto;">
                        @((MarkupString)renderedHtml)
                    </div>
                </div>

                @if (showCopied)
                {
                    <div class="alert alert-success mt-3">
                        <i class="bi bi-check-circle me-2"></i>å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼
                    </div>
                }
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            ç¼ºå°‘å¿…è¦è³‡æ–™ï¼Œè«‹è¿”å›é‡æ–°é¸æ“‡æ–¹æ¡ˆã€‚
        </div>
    }
</div>

<style>
    .markdown-content h1 { font-size: 1.75rem; margin-top: 1.5rem; color: #e2e8f0; }
    .markdown-content h2 { font-size: 1.35rem; margin-top: 1.25rem; color: #cbd5e1; border-bottom: 1px solid #334155; padding-bottom: 0.5rem; }
    .markdown-content h3 { font-size: 1.1rem; margin-top: 1rem; color: #94a3b8; }
    .markdown-content p { color: #cbd5e1; line-height: 1.7; }
    .markdown-content ul, .markdown-content ol { color: #cbd5e1; }
    .markdown-content table { width: 100%; margin: 1rem 0; border-collapse: collapse; }
    .markdown-content th, .markdown-content td { border: 1px solid #475569; padding: 0.5rem; color: #e2e8f0; }
    .markdown-content th { background: #1e293b; }
    .markdown-content pre { background: #0f172a; padding: 1rem; border-radius: 8px; overflow-x: auto; }
    .markdown-content code { color: #22d3ee; }
    .markdown-content pre.mermaid { background: #1e293b; text-align: center; padding: 1.5rem; }
</style>

@code {
    [SupplyParameterFromQuery]
    public string? Solution { get; set; }

    [SupplyParameterFromQuery]
    public string? Input { get; set; }

    private SolutionOption? solution;
    private RequirementInput? input;
    private string planMarkdown = "";
    private string renderedHtml = "";
    private bool isLoading = true;
    private bool showCopied = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (!string.IsNullOrEmpty(Solution))
            {
                var json = System.Text.Encoding.UTF8.GetString(Convert.FromBase64String(Solution));
                solution = System.Text.Json.JsonSerializer.Deserialize<SolutionOption>(json);
            }
            if (!string.IsNullOrEmpty(Input))
            {
                var json = System.Text.Encoding.UTF8.GetString(Convert.FromBase64String(Input));
                input = System.Text.Json.JsonSerializer.Deserialize<RequirementInput>(json);
            }

            if (solution != null && input != null)
            {
                planMarkdown = await PlanService.GeneratePlanAsync(input, solution);
                
                // Extract mermaid blocks BEFORE Markdig processing
                // Replace mermaid code blocks with placeholder divs
                var mermaidPattern = @"```mermaid\s*([\s\S]*?)```";
                var mermaidBlocks = new List<string>();
                planMarkdown = System.Text.RegularExpressions.Regex.Replace(
                    planMarkdown,
                    mermaidPattern,
                    m => {
                        var index = mermaidBlocks.Count;
                        mermaidBlocks.Add(m.Groups[1].Value.Trim());
                        return $"%%MERMAID_{index}%%";
                    }
                );
                
                // Render Markdown to HTML
                var pipeline = new MarkdownPipelineBuilder().UseAdvancedExtensions().Build();
                renderedHtml = Markdown.ToHtml(planMarkdown, pipeline);
                
                // Replace placeholders with actual mermaid divs
                for (int i = 0; i < mermaidBlocks.Count; i++)
                {
                    renderedHtml = renderedHtml.Replace(
                        $"<p>%%MERMAID_{i}%%</p>",
                        $"<div class=\"mermaid\">{System.Web.HttpUtility.HtmlEncode(mermaidBlocks[i])}</div>"
                    );
                    // Also handle case without <p> wrapper
                    renderedHtml = renderedHtml.Replace(
                        $"%%MERMAID_{i}%%",
                        $"<div class=\"mermaid\">{System.Web.HttpUtility.HtmlEncode(mermaidBlocks[i])}</div>"
                    );
                }
            }
        }
        catch (Exception ex)
        {
            planMarkdown = $"éŒ¯èª¤: {ex.Message}";
            renderedHtml = $"<p class='text-danger'>éŒ¯èª¤: {ex.Message}</p>";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/");
    }

    private async Task CopyToClipboard()
    {
        // Note: In production, use JS interop for clipboard
        showCopied = true;
        await Task.Delay(2000);
        showCopied = false;
    }

    private async Task DownloadMarkdown()
    {
        var fileName = $"implementation-plan-{DateTime.Now:yyyyMMdd-HHmm}.md";
        var bytes = System.Text.Encoding.UTF8.GetBytes(planMarkdown);
        var base64 = Convert.ToBase64String(bytes);
        
        // Using inline JS for download
        await Task.CompletedTask; // Placeholder - needs JS interop
    }
}
